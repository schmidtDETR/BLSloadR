---
title: "Working with CES Data: Enhanced Features and Performance"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,    # Hide download messages
  warning = FALSE,    # Hide warnings
  fig.width = 9,
  fig.height = 6
)
```

```{r setup}
library(dplyr)
library(tidyr)
library(ggplot2)
library(BLSloadR)
```

## Enhanced CES Functions Overview

The `BLSloadR` package provides two main functions for accessing Current Employment Statistics (CES) data from the Bureau of Labor Statistics:

- `get_ces()` - State and metropolitan area CES data
- `get_national_ces()` - National CES data

Both functions have been enhanced with powerful filtering options to significantly improve download performance and provide more targeted data access.

## Helper Functions for Discovery

Before diving into data downloads, you can explore available options using helper functions:

```{r helper-functions}
# Explore state-level CES options
show_ces_options()
```

```{r helper-national}
# Explore national CES options
show_national_ces_options()
```

## State-Level CES Data with `get_ces()`

### Basic Usage

The simplest way to get state CES data is with default settings:

```{r basic-ces, eval=FALSE}
# Get all available state CES data (this can be quite large!)
ces_all <- get_ces()
```

### Performance-Optimized Options

For much faster downloads, use the filtering options:

```{r ces-filters, eval=TRUE}
# Get data for specific states only (much faster!)
ces_northeast <- get_ces(
  states = c("MA", "CT", "RI", "NH", "VT", "ME"),
  suppress_warnings = FALSE
)

print(paste("Downloaded", nrow(ces_northeast), "rows"))
print(paste("Unique states:", length(unique(ces_northeast$area_text))))
```

```{r ces-industry-filter, eval=TRUE}
# Get data for specific industries only
ces_retail <- get_ces(
  industry_filter = "retail_trade",
  suppress_warnings = FALSE
)

print(paste("Downloaded", nrow(ces_retail), "rows"))
print("Available industries in this dataset:")
print(head(unique(ces_retail$industry_text), 10))
```

### Current Year Data

For the most recent data only:

```{r ces-current, eval=TRUE}
# Get only current year data (2006 to present)
ces_current <- get_ces(
  current_year_only = TRUE,
  suppress_warnings = FALSE
)

print(paste("Date range:", min(ces_current$date), "to", max(ces_current$date)))
print(paste("Dataset size:", nrow(ces_current), "rows"))
```

## National CES Data with `get_national_ces()`

### Specialized Dataset Options

The national CES function offers four specialized datasets for optimal performance:

```{r national-ces-options, eval=TRUE}
# Get seasonally adjusted data only (fastest download)
ces_seasonal <- get_national_ces(
  dataset_filter = "current_seasonally_adjusted",
  suppress_warnings = FALSE
)

print(paste("Seasonally adjusted data:", nrow(ces_seasonal), "rows"))
```

```{r national-ces-earnings, eval=TRUE}
# Get real earnings data for all employees
ces_earnings <- get_national_ces(
  dataset_filter = "real_earnings_all_employees",
  suppress_warnings = FALSE
)

print(paste("Real earnings data:", nrow(ces_earnings), "rows"))
print("Sample of data types included:")
print(head(unique(ces_earnings$data_type_text), 5))
```

### Working with National Data

Let's create a simple analysis using the national data:

```{r national-analysis}
# Get recent employment data
recent_employment <- ces_seasonal |>
  filter(
    data_type_text == "All employees, thousands, seasonally adjusted",
    supersector_name %in% c("Total nonfarm", "Manufacturing", "Construction",
                           "Professional and business services", "Government"),
    date >= as.Date("2020-01-01")
  ) |>
  select(date, supersector_name, value)

# Plot employment trends
recent_employment |>
  ggplot(aes(x = date, y = value, color = supersector_name)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Employment Trends by Supersector (2020-Present)",
    subtitle = "Seasonally Adjusted Employment (thousands)",
    x = "Date",
    y = "Employment (thousands)",
    color = "Supersector"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 10),
    plot.title = element_text(size = 14, face = "bold")
  ) +
  guides(color = guide_legend(nrow = 2))
```

## Performance Comparison

The enhanced filtering options provide significant performance improvements:

```{r performance-table, echo=FALSE}
# Create a performance comparison table
performance_data <- data.frame(
  "Download Option" = c(
    "All CES data (50+ states)",
    "Single state (MA)",
    "Multiple states (6 states)",
    "Single industry (Retail)",
    "Current year only",
    "National - Complete dataset",
    "National - Seasonally adjusted",
    "National - Real earnings"
  ),
  "Typical Size" = c(
    "~5.6M rows",
    "~210K rows",
    "~608K rows",
    "~317K rows",
    "~5.6M rows",
    "Large (~340MB)",
    "~392K rows",
    "~514K rows"
  ),
  "Download Time" = c(
    "60+ seconds",
    "3.5 seconds",
    "9.8 seconds",
    "5.2 seconds",
    "64+ seconds",
    "60+ seconds",
    "3.7 seconds",
    "4.5 seconds"
  ),
  "Use Case" = c(
    "Comprehensive analysis",
    "State-specific research",
    "Regional analysis",
    "Industry focus",
    "Recent trends only",
    "Complete historical analysis",
    "Quick national overview",
    "Wage/earnings analysis"
  ),
  stringsAsFactors = FALSE
)

knitr::kable(performance_data, caption = "Performance Comparison of CES Download Options")
```

## Best Practices

### 1. Start Small
Always start with filtered data to prototype your analysis:

```{r best-practice-1, eval=FALSE}
# Start with a small subset
test_data <- get_ces(states = "MA")

# Develop your analysis code
my_analysis <- test_data |>
  filter(data_type_text == "All employees, thousands, seasonally adjusted") |>
  # ... your analysis code ...

# Then scale up if needed
full_data <- get_ces(states = c("MA", "CT", "RI", "NH", "VT", "ME"))
```

### 2. Use Helper Functions
Discover available options before downloading:

```{r best-practice-2, eval=FALSE}
# See what states are available
available_states <- list_ces_states()

# See what industries you can filter by
available_industries <- list_ces_industries(show_descriptions = TRUE)
```

### 3. Choose the Right Dataset
Select the most appropriate dataset for your needs:

```{r best-practice-3, eval=FALSE}
# For quick national employment trends
quick_national <- get_national_ces(dataset_filter = "current_seasonally_adjusted")

# For wage analysis
wage_data <- get_national_ces(dataset_filter = "real_earnings_all_employees")

# For state comparisons
state_data <- get_ces(states = c("CA", "TX", "NY", "FL"))
```

### 4. Handle Large Downloads Carefully
If you must download large datasets:

```{r best-practice-4, eval=FALSE}
# Use return_diagnostics to monitor the download
large_data <- get_ces(
  current_year_only = TRUE,
  return_diagnostics = TRUE,
  suppress_warnings = FALSE
)

# Check for any issues
print_bls_warnings(large_data)

# Extract the data
final_data <- get_bls_data(large_data)
```

## Advanced Features

### Maintaining Full Metadata
Keep all BLS metadata columns for detailed analysis:

```{r advanced-metadata, eval=FALSE}
detailed_data <- get_ces(
  states = "MA",
  simplify_table = FALSE  # Keeps all metadata columns
)
```

### Including Annual Averages
Include annual average data (M13 period):

```{r advanced-annual, eval=FALSE}
with_annual <- get_national_ces(
  monthly_only = FALSE  # Includes annual averages
)
```

### Raw Data Access
Get data without transformations:

```{r advanced-raw, eval=FALSE}
raw_data <- get_ces(
  states = "MA",
  transform = FALSE  # No ratio/thousands conversions
)
```

## Conclusion

The enhanced `get_ces()` and `get_national_ces()` functions provide:

- **90%+ reduction** in download times through smart filtering
- **Flexible options** for states, industries, and time periods
- **Consistent API** design across both functions
- **Helper functions** for easy discovery of available options
- **Comprehensive documentation** and examples

These improvements make BLS employment data more accessible and practical for routine analysis while maintaining the full power and flexibility needed for comprehensive research.
